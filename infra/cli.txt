docker run -it --rm \
  -v $(pwd)/nginx/letsencrypt:/etc/letsencrypt \
  -v $(pwd)/nginx/cloudflare.ini:/cloudflare.ini \
  certbot/dns-cloudflare certonly \
  --dns-cloudflare \
  --dns-cloudflare-credentials /cloudflare.ini \
  -d '*.appf4s.io.vn' \
  -d appf4s.io.vn \
  --email shegga9x@gmail.com \
  --agree-tos \
  --non-interactive


export APP_F4_PASS="your_password_here"
echo $APP_F4_PASS  # Verify it's set


# Navigate to SSL directory
mkdir -p kafka/ssl
cd kafka/ssl/





# Create the broker configuration file
cat > kafka-broker.conf << EOF
[req]
distinguished_name = req_distinguished_name
req_extensions = v3_req
prompt = no

[req_distinguished_name]
CN = kafka-broker

[v3_req]
subjectAltName = @alt_names

[alt_names]
DNS.1 = kafka
DNS.2 = appf4s.io.vn
DNS.3 = localhost
IP.1 = 127.0.0.1
EOF

# Step 1: Generate CA private key
openssl genrsa -out ca-key.pem 4096

# Step 2: Generate CA certificate
openssl req -new -x509 -key ca-key.pem -sha256 -subj "/C=VN/ST=HCMC/L=HCMC/O=F4/CN=kafka-ca" -days 365 -out ca-cert.pem

# Step 3: Generate broker private key
openssl genrsa -out kafka-broker-key.pem 4096

# Step 4: Generate broker certificate request
openssl req -new -key kafka-broker-key.pem -out kafka-broker.csr -config kafka-broker.conf

# Step 5: Sign broker certificate with CA
openssl x509 -req -in kafka-broker.csr -CA ca-cert.pem -CAkey ca-key.pem -CAcreateserial -out kafka-broker-cert.pem -days 365 -extensions v3_req -extfile kafka-broker.conf

# Remove old keystores if they exist
rm -f kafka.broker.keystore.jks kafka.client.truststore.jks kafka.broker.p12

# Create broker keystore
openssl pkcs12 -export -in kafka-broker-cert.pem -inkey kafka-broker-key.pem -out kafka.broker.p12 -name kafka-broker -password pass:${APP_F4_PASS}

keytool -importkeystore \
  -deststorepass ${APP_F4_PASS} \
  -destkeypass ${APP_F4_PASS} \
  -destkeystore kafka.broker.keystore.jks \
  -srckeystore kafka.broker.p12 \
  -srcstoretype PKCS12 \
  -srcstorepass ${APP_F4_PASS} \
  -alias kafka-broker

# Create client truststore
keytool -import \
  -trustcacerts \
  -alias ca-cert \
  -file ca-cert.pem \
  -keystore kafka.client.truststore.jks \
  -storepass ${APP_F4_PASS} \
  -noprompt